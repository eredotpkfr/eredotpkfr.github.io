<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>_iter_meta() got an unexpected keyword argument 'timeout'</title><!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="_iter_meta() got an unexpected keyword argument ‘timeout’" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Sıradan bir Celery app" />
<meta property="og:description" content="Sıradan bir Celery app" />
<link rel="canonical" href="http://localhost:4000/turkish_topics/2020/03/09/iter_meta.html" />
<meta property="og:url" content="http://localhost:4000/turkish_topics/2020/03/09/iter_meta.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-09T11:25:23+03:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"_iter_meta() got an unexpected keyword argument ‘timeout’","dateModified":"2020-03-09T11:25:23+03:00","datePublished":"2020-03-09T11:25:23+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/turkish_topics/2020/03/09/iter_meta.html"},"url":"http://localhost:4000/turkish_topics/2020/03/09/iter_meta.html","description":"Sıradan bir Celery app","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" type="text/css" href="/assets/main.css">
</head>
<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">/</a></li><li><a href="/turkish">/turkish</a></li><li><a href="/english">/english</a></li><li><a href="/whoami">/whoami.txt</a></li></ul>
  </div>
</header>
<main>
      <h1 id="sıradan-bir-celery-app">Sıradan bir Celery app</h1>

<p>Celery ile basit bir uygulama yazalım, bu yazdığımız uygulama parametre olarak verdiğimiz bir değerin <code class="language-plaintext highlighter-rouge">len()</code> çıktısını geri döndürsün. O hâlde kodumuz aşağıdaki gibi olacaktır.</p>

<h1 id="taskspy">tasks.py</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
		<span class="s">'tasks'</span><span class="p">,</span>
		<span class="n">broker</span><span class="o">=</span><span class="s">'redis://localhost:6379/0'</span><span class="p">,</span>
		<span class="n">backend</span> <span class="o">=</span> <span class="s">'redis://localhost:6379/0'</span>
	<span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><br />Şimdi ise yeni bir terminalden python3 yorumlayıcısı açalım ve tasks dosyasındaki <code class="language-plaintext highlighter-rouge">length()</code> fonksiyonumuzu import edelim ve celery workerlarına bu işlevi çalıştırmasını söyleyelim. Bu esnada da celery workerlarını takip edelim bunun için <code class="language-plaintext highlighter-rouge">celery -q -A tasks worker -l info</code> şeklinde komut çalıştırmamız yeterli olacaktır.</p>

<h1 id="celery--q--a-tasks-worker--l-info">celery -q -A tasks worker -l info</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">235</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">6379</span><span class="o">/</span><span class="mi">0</span>
<span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">244</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="n">searching</span> <span class="k">for</span> <span class="n">neighbors</span>
<span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">263</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="nb">all</span> <span class="n">alone</span>
<span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">295</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="o">@</span><span class="n">eredotpkfr</span> <span class="n">ready</span><span class="p">.</span>
<span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span><span class="mi">253</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">tasks</span><span class="p">.</span><span class="n">length</span><span class="p">[</span><span class="mi">9</span><span class="n">bccfa35</span><span class="o">-</span><span class="n">a6e6</span><span class="o">-</span><span class="mf">4e45</span><span class="o">-</span><span class="mi">8163</span><span class="o">-</span><span class="n">d8132c7d05bc</span><span class="p">]</span>  
<span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span><span class="mi">256</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="n">Task</span> <span class="n">tasks</span><span class="p">.</span><span class="n">length</span><span class="p">[</span><span class="mi">9</span><span class="n">bccfa35</span><span class="o">-</span><span class="n">a6e6</span><span class="o">-</span><span class="mf">4e45</span><span class="o">-</span><span class="mi">8163</span><span class="o">-</span><span class="n">d8132c7d05bc</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.0028191699998387776</span><span class="n">s</span><span class="p">:</span> <span class="mi">7</span></code></pre></figure>

<p><br />Çıktıya baktığımızda herhangi bir problem gözükmüyor, worker task’ı almış ve 0.002 saniye içerisinde sonuç döndürmüş. Döndürdüğü değer ise 7 fakat python3 yorumlayıcımıza baktığımızda!</p>

<h1 id="python3">python3</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Python</span> <span class="mf">3.7</span><span class="p">.</span><span class="mi">5</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Nov</span> <span class="mi">20</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">09</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">52</span><span class="p">)</span> 
<span class="p">[</span><span class="n">GCC</span> <span class="mf">9.2</span><span class="p">.</span><span class="mi">1</span> <span class="mi">20191008</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"copyright"</span><span class="p">,</span> <span class="s">"credits"</span> <span class="ow">or</span> <span class="s">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">length</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">length</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="s">'python3'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"/home/eredot_pkfr/.local/lib/python3.7/site-packages/celery/result.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">228</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get</span>
    <span class="n">on_message</span><span class="o">=</span><span class="n">on_message</span><span class="p">,</span>
  <span class="n">File</span> <span class="s">"/home/eredot_pkfr/.local/lib/python3.7/site-packages/celery/backends/asynchronous.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">200</span><span class="p">,</span> <span class="ow">in</span> <span class="n">wait_for_pending</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_wait_for_pending</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"/home/eredot_pkfr/.local/lib/python3.7/site-packages/celery/backends/asynchronous.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">263</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_wait_for_pending</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">on_wait_for_pending</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">"/home/eredot_pkfr/.local/lib/python3.7/site-packages/celery/backends/redis.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">150</span><span class="p">,</span> <span class="ow">in</span> <span class="n">on_wait_for_pending</span>
    <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">_iter_meta</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">_iter_meta</span><span class="p">()</span> <span class="n">got</span> <span class="n">an</span> <span class="n">unexpected</span> <span class="n">keyword</span> <span class="n">argument</span> <span class="s">'timeout'</span>
<span class="o">&gt;&gt;&gt;</span> </code></pre></figure>

<p><br /><code class="language-plaintext highlighter-rouge">res = length.delay('python3')</code> komutunu verdiğimizde celery worker işi yapmaya başladı ve bize bir sonuç döndürdü. Celery kütüphanesinde sonucu görmek için kullandığımız birkaç metod var bunlardan biri <code class="language-plaintext highlighter-rouge">wait()</code> metodudur, <code class="language-plaintext highlighter-rouge">wait()</code> metodu task’ın bitmesini bekler ve bittiğinde sonucu döndürür. <code class="language-plaintext highlighter-rouge">wait()</code> metodu yerine <code class="language-plaintext highlighter-rouge">get()</code> metoduda kullanılabilir, yukarıda <code class="language-plaintext highlighter-rouge">wait()</code> metodunu çağırdığımızda <code class="language-plaintext highlighter-rouge">TypeError: _iter_meta() got an unexpected keyword argument 'timeout'</code> hatası ile karşılaşıyoruz. Bu hatada <code class="language-plaintext highlighter-rouge">_iter_meta()</code> fonksiyonunun beklenmeyen bir ‘timeout’ argümanını aldığını söylüyor. Aslında hatanın sebebi şurada, <code class="language-plaintext highlighter-rouge">wait()</code> metodunu çağırdığımızda bize veriyi döndürmüyor ve hata veriyor fakat <code class="language-plaintext highlighter-rouge">res.ready()</code> şeklinde bir çıtı istediğimizde <code class="language-plaintext highlighter-rouge">True</code> değerini döndürüyor, veriyi alabiliriz şuanda hazır fakat <code class="language-plaintext highlighter-rouge">wait()</code> metodu bize veriyi getirmiyor! işlevini tam olarak yerine getiremiyor aynı şekilde <code class="language-plaintext highlighter-rouge">get()</code> metoduda veriyi getiremiyor ve hata veriyor. İş bittiği için ‘timeout’ yiyoruz aslında fakat hata direkt karşımıza bu şekilde çıkmıyor.
<br />Normal şartlarda bu şekilde bir hata ile karşılaşılmaması lazım çünkü <code class="language-plaintext highlighter-rouge">wait()</code> metodu task’ın bitmesini bekler. <code class="language-plaintext highlighter-rouge">wait()</code> metodu görevini yerine getiremiyor ise biz kendimiz işlev bitesiye kadar beklemeyi seçebiliriz.  Böyle bir durumda aşağıdaki alternatif yöntemleri uygulamak çözüm olacaktır <code class="language-plaintext highlighter-rouge">wait()</code> metodu da aslında aşağıdakilere benzer bir yöntem kullanır!</p>

<h1 id="alternativespy">alternatives.py</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="c1"># Imports
</span><span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">length</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="c1"># 0
</span><span class="n">res</span> <span class="o">=</span> <span class="n">length</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="s">'alternative_0'</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">res</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'SUCCESS'</span><span class="p">:</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># result.wait(timeout=None, interval=0.5) is the same \
# thing as the above code!
</span><span class="k">print</span><span class="p">(</span>
	<span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="c1"># returns result
</span>	<span class="n">res</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="c1"># returns task id (str)
</span>	<span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="c1"># returns task status (str)
</span>	<span class="n">res</span><span class="p">.</span><span class="n">info</span> <span class="c1"># returns task information
</span><span class="p">)</span>
<span class="c1"># 1
</span><span class="n">res</span> <span class="o">=</span> <span class="n">length</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="s">'alternative_1'</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">res</span><span class="p">.</span><span class="n">ready</span><span class="p">():</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span>
	<span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
	<span class="n">res</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="c1"># returns task id (str)
</span>	<span class="n">res</span><span class="p">.</span><span class="n">ready</span><span class="p">(),</span> <span class="c1"># returns task is ready? (boolean)
</span>	<span class="n">res</span><span class="p">.</span><span class="n">info</span>
<span class="p">)</span>
<span class="c1"># 2
</span><span class="n">res</span> <span class="o">=</span> <span class="n">length</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="s">'alternative_2'</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">res</span><span class="p">.</span><span class="n">successful</span><span class="p">():</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span>
	<span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
	<span class="n">res</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
	<span class="n">res</span><span class="p">.</span><span class="n">successful</span><span class="p">(),</span> <span class="c1"># returns task is ready? (boolean)
</span>	<span class="n">res</span><span class="p">.</span><span class="n">info</span>
<span class="p">)</span>

<span class="c1"># OUTPUT
</span>
<span class="c1"># 13 cdece656-372b-46c2-9956-5b6c8a296a7f SUCCESS 13
# 13 1634167e-9aee-42c3-8bd9-828b34525a99 True 13
# 13 f086e8f7-7a1b-42b6-98f3-362f43a1cbfd True 13</span>
</pre></td></tr></tbody></table></code></pre></figure>



    </main><footer>
  <a href="https://www.github.com/eredotpkfr/my_n0t3s/" target="_blank">my_n0t3s</a> | <a href="https://twitter.com/eredot_pkfr" target="_blank">twitter</a> | <a href="https://github.com/eredotpkfr/" target="_blank">github</a> | <a href="https://www.erdoganyoksul.com/pgp.txt" target="_blank">pgp</a> |
</footer>
</div>
  </body>
</html>
